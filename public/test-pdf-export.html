<!DOCTYPE html>
<html>
<head>
    <title>PDF Export Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #test-svg { border: 1px solid #ccc; margin: 20px 0; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        #status { margin: 20px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>PDF Export Test</h1>
    <p>This test verifies the SVG-to-PDF conversion logic works correctly.</p>
    
    <!-- Test SVG similar to what Gantt chart would generate -->
    <svg id="test-svg" width="800" height="400" xmlns="http://www.w3.org/2000/svg">
        <rect width="800" height="400" fill="white" stroke="#ccc"/>
        
        <!-- Simulate Gantt chart bars -->
        <rect x="50" y="50" width="200" height="30" fill="#f36868" stroke="#333"/>
        <text x="60" y="70" font-size="12" fill="#333">Task 1</text>
        
        <rect x="100" y="100" width="300" height="30" fill="#f5d76e" stroke="#333"/>
        <text x="110" y="120" font-size="12" fill="#333">Task 2</text>
        
        <rect x="150" y="150" width="150" height="30" fill="#34d399" stroke="#333"/>
        <text x="160" y="170" font-size="12" fill="#333">Task 3</text>
        
        <!-- Grid lines -->
        <defs>
            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#eee" stroke-width="1"/>
            </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#grid)" />
        
        <!-- Axis labels -->
        <text x="25" y="35" font-size="14" font-weight="bold" fill="#333">Tasks</text>
        <text x="50" y="25" font-size="12" fill="#666">Jan</text>
        <text x="150" y="25" font-size="12" fill="#666">Feb</text>
        <text x="250" y="25" font-size="12" fill="#666">Mar</text>
        <text x="350" y="25" font-size="12" fill="#666">Apr</text>
    </svg>
    
    <button onclick="testPdfExport()">Export to PDF (Fixed Method)</button>
    <button onclick="testOldMethod()">Test Old Method (Broken)</button>
    
    <div id="status">Ready to test</div>

    <script>
        // New improved method (our fix)
        async function testPdfExport() {
            const status = document.getElementById('status');
            status.textContent = 'Exporting...';
            status.style.color = 'blue';
            
            const svg = document.getElementById('test-svg');
            
            try {
                // Get SVG dimensions
                const svgRect = svg.getBoundingClientRect();
                const svgWidth = svgRect.width || 800;
                const svgHeight = svgRect.height || 400;
                
                // Create a canvas element
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (!ctx) {
                    status.textContent = 'Error: Could not get canvas context';
                    status.style.color = 'red';
                    return;
                }
                
                // Set canvas size with scale factor for better quality
                const scale = 2;
                canvas.width = svgWidth * scale;
                canvas.height = svgHeight * scale;
                ctx.scale(scale, scale);
                
                // Convert SVG to data URL
                const svgData = new XMLSerializer().serializeToString(svg);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const svgUrl = URL.createObjectURL(svgBlob);
                
                // Create an image element and load the SVG
                const img = new Image();
                
                img.onload = () => {
                    // Draw the image on canvas
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, svgWidth, svgHeight);
                    ctx.drawImage(img, 0, 0, svgWidth, svgHeight);
                    
                    // Convert canvas to image data
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();
                    
                    // Calculate scaling to fit the page while maintaining aspect ratio
                    const imgAspectRatio = svgWidth / svgHeight;
                    const pdfAspectRatio = pdfWidth / pdfHeight;
                    
                    let finalWidth, finalHeight;
                    if (imgAspectRatio > pdfAspectRatio) {
                        // Image is wider, scale by width
                        finalWidth = pdfWidth - 20; // 10px margin on each side
                        finalHeight = finalWidth / imgAspectRatio;
                    } else {
                        // Image is taller, scale by height
                        finalHeight = pdfHeight - 20; // 10px margin on top and bottom
                        finalWidth = finalHeight * imgAspectRatio;
                    }
                    
                    // Center the image
                    const x = (pdfWidth - finalWidth) / 2;
                    const y = (pdfHeight - finalHeight) / 2;
                    
                    // Add image to PDF
                    doc.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                    doc.save('gantt-chart-fixed.pdf');
                    
                    status.textContent = 'PDF exported successfully! Check your downloads for gantt-chart-fixed.pdf';
                    status.style.color = 'green';
                    
                    // Clean up
                    URL.revokeObjectURL(svgUrl);
                };
                
                img.onerror = () => {
                    status.textContent = 'Error: Failed to load SVG image';
                    status.style.color = 'red';
                    URL.revokeObjectURL(svgUrl);
                };
                
                img.src = svgUrl;
                
            } catch (error) {
                status.textContent = 'Error: ' + error.message;
                status.style.color = 'red';
            }
        }
        
        // Old broken method for comparison
        function testOldMethod() {
            const status = document.getElementById('status');
            status.textContent = 'Testing old method...';
            status.style.color = 'orange';
            
            const svg = document.getElementById('test-svg');
            const svgData = new XMLSerializer().serializeToString(svg);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("landscape");
            
            try {
                doc.html(svgData, {
                    callback: function (doc) {
                        doc.save("gantt-chart-old.pdf");
                        status.textContent = 'Old method completed - check gantt-chart-old.pdf (likely broken/empty)';
                        status.style.color = 'orange';
                    },
                    x: 10,
                    y: 10,
                });
            } catch (error) {
                status.textContent = 'Old method error: ' + error.message;
                status.style.color = 'red';
            }
        }
    </script>
</body>
</html>